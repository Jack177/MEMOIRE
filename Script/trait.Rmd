---
title: "cca"
author: "Jordan"
date: "`r Sys.Date()`"
output: html_document
---


```{r}
# Load the required packages
library(dplyr)
library(vegan) # specpool () estimateR() poolaccum() estaccumR()
library(ggplot2)
library(forcats )
library(reshape2)
library("readxl") 


```

# Note !!! : j'ai supprimé les Apis mellifera sur l'Excel !!
à refaire si nouvelle donnée encodée !!
```{r Nettoyage}
# Tour PC
#setwd("D:/OneDrive - UMONS/UMONS/MA2/MEMOIRE/Statistique/R/STAT-MEMOIRE/RAW/Traits abeilles")
# Laptop
setwd("C:/Users/Jordan/OneDrive - UMONS/UMONS/MA2/MEMOIRE/Statistique/R/STAT-MEMOIRE/RAW/Traits abeilles")

SpecCondStat <- read_excel("SpecCondStat_traits.xls")

# Nom plus compact
SCS <- SpecCondStat

# Retirer le site de Condorcet
SCS <- filter(SCS, TOPO != "Condorcet" )

# Renommer plus simplement
rename(SCS, "sp" = "SPEC.TAXPRIO" ) -> SCS
rename(SCS, "site" = "TOPO" ) -> SCS
rename(SCS, "family" = "SPEC.GR2" ) -> SCS

# Retirer les observations contenant l'espèce : "Apis mellifera"
SCS <- filter(SCS, sp != "Apis mellifera" )

# Remplacement des noms d'espèces désuets
SCS$sp[SCS$sp == "Bombus (Bombus)  sp."] <- "Terrestribombus  sp."
SCS$sp[SCS$sp == "Bombus lucorum"] <- "Terrestribombus  sp."
SCS$sp[SCS$sp == "Bombus terrestris"] <- "Terrestribombus  sp."
SCS$sp[SCS$sp == "Chalicodoma ericetorum"] <- "Megachile ericetorum"
SCS$sp[SCS$sp == "Halictus tumulorum"] <- "Seladonia tumulorum"
SCS$sp[SCS$sp == "Halictus tumulorum"] <- "Seladonia tumulorum"

# Remplacement du noms de sites
SCS$site[SCS$site == "Les Gourmandes de la Procession"] <- "Gourmandes"


```


Importation des données.
```{r}
# Tour PC
setwd("D:/OneDrive - UMONS/UMONS/MA2/MEMOIRE/Statistique/R/STAT-MEMOIRE/RAW2/Traits abeilles")
# Laptop
#setwd("C:/Users/Jordan/OneDrive - UMONS/UMONS/MA2/MEMOIRE/Statistique/R/STAT-MEMOIRE/RAW2/Traits abeilles")

# Import
traits <- read_excel("Trait-bee-each-site.xlsx")

# Réécriture des noms de familles
traits$familly[traits$familly == "ANDRENIDAE"] <- "Andrenidae"
traits$familly[traits$familly == "APIDAE"] <- "Apidae"
traits$familly[traits$familly == "COLLETIDAE"] <- "Colletidae"
traits$familly[traits$familly == "HALICTIDAE"] <- "Halictidae"
traits$familly[traits$familly == "MEGACHILIDAE"] <- "Megachilidae"
traits$familly[traits$familly == "MELITTIDAE"] <- "Melittidae"

# Remplacement du noms de sites
traits$site[traits$site == "Les Gourmandes de la Procession"] <- "Gourmandes"
```

```{r}
SCS %>%
  group_by(sp, site) %>%
  count(sp) -> df0 
rename(df0, "tot" = "n" ) -> df0
df0 <- filter(df0, tot == "1")
```

```{r}
SCS %>%
  group_by(sp) %>%
  count(sp) -> df1 
rename(df1, "tot" = "n" ) -> df1
```

```{r}
SCS %>%
  group_by(sp, SEX, family) %>%
  count(sp) -> df2
rename(df2, "tot" = "n" ) -> df2
```



```{r}
SCS %>%
  group_by(site, sp) %>%
  count(sp) -> df 
# df <- filter(df, site == "Siege social")
df <- filter(df, site == "Village des abeilles")
df2 <- select(df, -site)

ss <- dplyr::inner_join(df2 , df1, by = "sp")
ss$Percentage <- round((ss$n/ss$tot)*100 , digits = 0)
# table(df$sp)
```


Tri sp terricole
```{r}
terricole <- filter(traits, Nest_area == "Soil")
cavite <- filter(traits, Nest_area == "Cavities" & site == "Village des abeilles")

```

```{r}
# traits %>%
#   group_by(Nest_area, site) %>%
#   summarise(n = n()) %>%
#   mutate(Freq = n/sum(n)) -> df 
traits %>%
  group_by(Nest_area, site) %>%
  summarise(n = n()) -> df 
```
Barplot sp par site selon nidification 
```{r}
ggplot(df, aes(x = site, y = n, fill = Nest_area, label = n)) +
  geom_bar(stat = "identity") +
  geom_text(size = 3, position = position_stack(vjust = 0.5))
```

```{r}
SCS %>%
  group_by(Nest_area, site) %>%
  count(Nest_area) -> df 
```

Barplot abondance par site selon nidification 
```{r}
#mycolors <- c("seashell4", "sienna1", "wheat", "tan4", "olivedrab1", "cadetblue2", "yellowgreen", "burlywood4")
mycolors <- c("Cavities" = "seashell4", "Next to stems" =  "sienna1", "Snails" = "wheat", "Soil" = "#BC9369", "Stems" = "greenyellow", "Variable" = "lightblue", "Vegetation" = "chartreuse3", "Wood" = "burlywood4")

# Ordonner par "Soil"
df$Nest_area <- factor(df$Nest_area, levels = c( "Cavities" , "Next to stems" , "Snails",  "Stems" , "Variable" ,"Vegetation",  "Wood","Soil"))
df$site=factor(df$site, levels = df[with(df,order(n,decreasing = T)) ,][df[with(df,order(n,decreasing = T)) ,]$Nest_area=="Soil",]$site)


ggplot(df, aes(x = site, y = n, fill = Nest_area, label = n)) +
  geom_bar(stat = "identity") +
  geom_text(size = 3, position = position_stack(vjust = 0.5)) +
  scale_fill_manual("", values = mycolors ) +
  labs(title = "", x = "", y = "Nombre d'individus") + # Titre et titre axe
  # scale_fill_brewer(palette="Pastel1")
  theme(axis.text.x = element_text(angle = 90, vjust = 0, size = 10, hjust = 0),
        axis.text.y = element_text(size = 10, hjust = 0,  vjust = 0.4,face="bold"),
        panel.background = element_rect(fill='white', colour='black'),
        legend.position = "bottom")
```
Ancienne version
Barplot abondance par site selon nidification 
```{r}
# ggplot(traits, aes(x = site, y = N, fill = Nest_area, label = N)) +
#   geom_bar(stat = "identity") +
#   geom_text(size = 3, position = position_stack(vjust = 0.5))
```

Nombre et pourcentage totals de Nest_area
```{r}
# Nombre par catégorie
table(traits$Nest_area)
# Pourcentage 
traits %>% group_by(Nest_area) %>% summarise(Percentage=round( (n()/nrow(.))*100 , digits = 0)) -> pct 
pct[order(-pct$Percentage),]
#sum(pct$Percentage)
```
Nombre d'individus par espèces terricoles tous site confondu
```{r}

SCS %>%
  filter(Nest_area == "Soil") %>%
  group_by(Nest_area, sp) %>%
  count(Nest_area) -> Soil 
```




